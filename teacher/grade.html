<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æˆç¸¾æŸ¥è©¢</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .exam-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }
        #exam-title {
            text-align: center;
            font-size: 20px;
            margin-top: 15px;
            font-weight: bold;
            display: none; /* é è¨­ä¸é¡¯ç¤º */
        }
    </style>
</head>
<body>
    <div id="grades-page" class="center-box">
        <h1>æˆç¸¾æŸ¥è©¢</h1>

        <!-- ä¸‹æ‹‰å¼é¸å–® + æ–°å¢å°è€ƒæŒ‰éˆ• -->
        <div class="exam-controls">
            <label for="exam-select">é¸æ“‡è€ƒè©¦ï¼š</label>
            <select id="exam-select">
                <option value="">è«‹é¸æ“‡</option>
            </select>
            
        </div>

        <div>
            <button id="add-exam-btn" class="primary-btn">â• æ–°å¢å°è€ƒ</button>
        </div>
        <!-- å°è€ƒæ¨™é¡Œ -->
        <div id="exam-title"></div>

        <!-- æˆç¸¾è¡¨ -->
        <table border="1" cellpadding="10" cellspacing="0" style="margin-top:20px; width:100%; text-align:center;">
            <thead>
                <tr>
                    <th>å­¸è™Ÿ</th>
                    <th>å§“å</th>
                    <th>åˆ†æ•¸</th>
                </tr>
            </thead>
            <tbody id="grades-table-body">
                <tr><td colspan="3">è«‹å…ˆé¸æ“‡è€ƒè©¦</td></tr>
            </tbody>
        </table>

        <!-- å„²å­˜æˆç¸¾æŒ‰éˆ•ï¼ˆé è¨­éš±è—ï¼‰ -->
        <div style="text-align:center; margin-top:20px;">
            <button id="save-exam-btn" class="primary-btn" style="display:none;">ğŸ’¾ å„²å­˜æˆç¸¾</button>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const classId = urlParams.get("classId");

        const examSelect = document.getElementById("exam-select");
        const gradesTableBody = document.getElementById("grades-table-body");
        const addExamBtn = document.getElementById("add-exam-btn");
        const saveExamBtn = document.getElementById("save-exam-btn");
        const examControls = document.querySelector(".exam-controls");
        const examTitle = document.getElementById("exam-title");

        let currentExamName = null;

        // å–å¾—è€ƒè©¦æ¸…å–®
        if (classId) {
            fetch(`http://26.218.4.126:5000/api/get-exams?classId=${classId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.exams && data.exams.length > 0) {
                        data.exams.forEach(exam => {
                            const option = document.createElement("option");
                            option.value = exam;
                            option.textContent = exam;
                            examSelect.appendChild(option);
                        });
                    }
                })
                .catch(err => console.error("Error:", err));
        }

        // é¸æ“‡è€ƒè©¦ â†’ é¡¯ç¤ºæˆç¸¾
        examSelect.addEventListener("change", () => {
            const exam = examSelect.value;
            if (!exam) {
                gradesTableBody.innerHTML = "<tr><td colspan='3'>è«‹å…ˆé¸æ“‡è€ƒè©¦</td></tr>";
                saveExamBtn.style.display = "none";
                examTitle.style.display = "none";
                return;
            }

            fetch(`http://26.218.4.126:5000/api/get-exam-grades?classId=${classId}&exam=${exam}`)
                .then(res => res.json())
                .then(data => {
                    gradesTableBody.innerHTML = "";
                    if (data.grades && data.grades.length > 0) {
                        data.grades.forEach(row => {
                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                                <td>${row.student_id}</td>
                                <td>${row.student_name || "-"}</td>
                                <td contenteditable="true" 
                                    onblur="updateScore('${row.student_id}', '${exam}', this.innerText)">
                                    ${row.score ?? "-"}
                                </td>
                            `;
                            gradesTableBody.appendChild(tr);
                        });
                        saveExamBtn.style.display = "none";
                        examTitle.style.display = "block";
                        examTitle.innerText = "è€ƒè©¦åç¨±ï¼š" + exam;
                    } else {
                        gradesTableBody.innerHTML = "<tr><td colspan='3'>æš«ç„¡æˆç¸¾è³‡æ–™</td></tr>";
                        saveExamBtn.style.display = "none";
                    }
                })
                .catch(err => {
                    console.error("Error:", err);
                    gradesTableBody.innerHTML = "<tr><td colspan='3'>âš ï¸ è¼‰å…¥å¤±æ•—</td></tr>";
                });
        });

        // æ›´æ–°åˆ†æ•¸åˆ°å¾Œç«¯
        function updateScore(studentId, examName, newScore) {
            fetch(`http://26.218.4.126:5000/api/update-grade`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    classId: classId,
                    student_id: studentId,
                    exam_name: examName,
                    score: newScore
                })
            })
            .then(res => res.json())
            .then(data => {
                console.log(data.message);
            })
            .catch(err => {
                console.error("æ›´æ–°å¤±æ•—:", err);
                alert("æˆç¸¾æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
            });
        }

        // é¡¯ç¤ºæ–°å¢å°è€ƒï¼ˆé‡ç”¨è¡¨æ ¼ï¼‰
        addExamBtn.addEventListener("click", () => {
            const examName = prompt("è«‹è¼¸å…¥è€ƒè©¦åç¨±ï¼š");
            if (!examName) {
                alert("å¿…é ˆè¼¸å…¥è€ƒè©¦åç¨±ï¼");
                return;
            }
            currentExamName = examName;

            // éš±è—é¸æ“‡è€ƒè©¦å’Œæ–°å¢å°è€ƒ
            examControls.style.display = "none";

            // é¡¯ç¤ºå°è€ƒæ¨™é¡Œ
            examTitle.style.display = "block";
            examTitle.innerText = "æ–°å¢è€ƒè©¦ï¼š" + currentExamName;

            gradesTableBody.innerHTML = "<tr><td colspan='3'>è¼‰å…¥ä¸­...</td></tr>";

            fetch(`http://26.218.4.126:5000/api/get-students?classId=${classId}`)
                .then(res => res.json())
                .then(data => {
                    gradesTableBody.innerHTML = "";
                    if (data.students && data.students.length > 0) {
                        data.students.forEach(stu => {
                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                                <td>${stu.student_id}</td>
                                <td>${stu.student_name}</td>
                                <td contenteditable="true"></td>
                            `;
                            gradesTableBody.appendChild(tr);
                        });
                        saveExamBtn.style.display = "inline-block";
                    } else {
                        gradesTableBody.innerHTML = "<tr><td colspan='3'>æ²’æœ‰å­¸ç”Ÿè³‡æ–™</td></tr>";
                    }
                });
        });

        // å„²å­˜æ–°å°è€ƒæˆç¸¾
        saveExamBtn.addEventListener("click", () => {
            if (!currentExamName) {
                alert("æ²’æœ‰æŒ‡å®šè€ƒè©¦åç¨±ï¼");
                return;
            }

            const grades = [];
            gradesTableBody.querySelectorAll("tr").forEach(tr => {
                const tds = tr.querySelectorAll("td");
                if (tds.length === 3) {
                    grades.push({
                        student_id: tds[0].innerText,
                        student_name: tds[1].innerText,
                        score: tds[2].innerText || 0
                    });
                }
            });

            fetch("http://26.218.4.126:5000/api/add-exam", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    classId: classId,
                    exam_name: currentExamName,
                    grades: grades
                })
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                location.reload();
            })
            .catch(err => {
                console.error("Error:", err);
                alert("å„²å­˜å¤±æ•—ï¼");
            });
        });
    </script>
</body>
</html>
